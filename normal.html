<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>jgeditor</title>
<style type="text/css" media="screen">
#editor { 
	width:500px;
	height:500px;
}
.game-container {
	min-width:500px;
	min-height:500px;
	padding:0;
	margin:0;
	border:0;
}
#error-console {
	width:500px;
	height:120px;
}
#output {
	width:500px;
	height:120px;
}
.l {
	float:left;
}
.r {
	float:right;
}
.c {
	clear:both;
}
</style>
<script type="text/javascript" src="js//ts/typescript.js"></script>
<script type="text/javascript" src="js/ace/ace.js"></script>
<script type="text/javascript" src="js/editor.jgame.js"></script>
<script type="text/javascript" src="js/jgame.js"></script>
<script type="text/javascript">
var editor;
(function() {
window.onload = function() {
	editor = ace.edit("editor");
	editor.setTheme("ace/theme/monokai");
	editor.getSession().setMode("ace/mode/typescript");

	var f = window.editorFunc = {}
	var lodaing = true;

	var defines = new jgeditor.DefineLoader();
	defines.load("lib", "define/lib.d.ts");
	defines.load("jgame", "define/jgame.d.ts");
	defines.load("webaudio", "define/webaudio.d.ts");
	defines.onload = function() {
		loading = false;
		compiler = new TypeScript.TypeScriptCompiler(errors, consoleLogger);
		var d = [];
		for (var i in defines.d)
			d.push(defines.d[i]);
		compiler.addUnit(d.join("\n"), "defines.d.ts");
		//compiler.addUnit("class dummy {}", "main.ts");
	}

	var consoleLogger = new jgeditor.ConsoleLogger();
	var errors = new jgeditor.SimpleBuffer();
	var compiler;

	f.build = function() {
		var compiler = f.check();
		if (! compiler)
			return null;
		if (errors.hasData())
			return null;

		var iohost = new jgeditor.IOHost();
		compiler.emit(iohost);
		document.getElementById("output").value = iohost.toString();
	}
	f.check = function() {
		if (loading)
			return null;
		errors.Clear();
		var prog = editor.getValue();
		var fname = "main.ts";
		try {
			var script;
			for (var i=0; i<compiler.units.length; i++) {
				if (compiler.units[i].filename == fname) {
					compiler.updateUnit(prog, fname, false);
					script = compiler.scripts.members[i];
					break;
				}
			}
			if (!script)
				script = compiler.addUnit(prog, fname);

			compiler.reTypeCheck();
		} catch(ex) {
			errors.WriteLine(ex.toString());
		}
		
		if (errors.hasData())
			document.getElementById("error-console").value = errors.toString();
		else
			document.getElementById("error-console").value = "No error!";

		return compiler;
	}
	f.run = function() {
		if (loading)
			return;
		var prog = document.getElementById("output").value;
		if (! prog) {
			alert("ビルド済みのコードが存在しません。");
			return;
		}
		var request = new XMLHttpRequest();
		request.open("POST", "save.php");
		request.send(prog);
		request.onload = function() {
			document.getElementById("jgame-con").src = "load.php?"+(new Date()).getTime();
		}
		request.onerror = function() {

		}
	}
	f.stop = function() {
		document.getElementById("jgame-con").src = "about:blank"
	}

    editor.commands.addCommands([{
        name: "check",
        bindKey: "Ctrl-S",
        exec: f.check
    }]);
    editor.commands.addCommands([{
        name: "build",
        bindKey: "Ctrl-B",
        exec: f.build
    }]);
    editor.commands.addCommands([{
        name: "run",
        bindKey: "Ctrl-R",
        exec: f.run
    }]);
    editor.commands.addCommands([{
        name: "stop",
        bindKey: "Ctrl-Shift-R",
        exec: f.stop
    }]);

}
})();
</script>
</head>
<body>
<div>
	<div id="editor" class="l">class SampleScene extends jg.Scene {
    shapes:jg.Shape[];
    logo:jg.Sprite;
    constructor(game:jg.Game) {
        super(game);
        this.logo = new jg.Sprite(game.r("logo"));
        this.logo.moveTo(
            this.game.width / 2 - this.logo.width / 2,
            this.game.height / 2 - this.logo.height / 2
        );
        this.append(this.logo);
        this.shapes = [];
        for (var i=0; i&lt;50; i++) {
            var shape = new jg.Shape(32, 32, jg.ShapeStyle.Fill);
            this.shapes.push(shape);
            this.append(shape);
        }
        this.started.handle(this, this.anime);
    }
    anime() {
        var game = this.game;
        for (var i=0; i&lt;this.shapes.length; i++) {
            this.shapes[i].tl().tween({
                x: () =&gt; { return game.random(0,480-32); },
                y: () =&gt; { return game.random(0,480-32); },
                rotate: () =&gt; { return game.random(0, 360); },
                time: 1000
            }).loop()
        }
    }
}

window.onload = function() {
    var game = new jg.Game(480, 480);
    game.preload({logo: "http://jgame-js.sourceforge.jp/img/logo-m.png"});
    game.loaded.handle(function() {
        var scene = new SampleScene(game);
        game.changeScene(scene);
    });	
}</div>
	<div class="l game-container">
		<iframe id="jgame-con" class="game-container"></iframe>
	</div>
	<div class="c"></div>
</div>
<div>
	<input type="button" value="型チェック(Ctrl+S)" onclick="window.editorFunc.check()" />
	<input type="button" value="ビルド(Ctrl+B)" onclick="window.editorFunc.build()" />
	<input type="button" value="実行(Ctrl+R)" onclick="window.editorFunc.run()" />
	<input type="button" value="停止(Ctrl+Shift+R)" onclick="window.editorFunc.stop()" />
</div>
<div>
	<div class="l">
		<textarea id="error-console"></textarea>
	</div>
	<div class="l">
		<textarea id="output"></textarea>
	</div>
	<div class="c"></div>
</div>
</body>
</html>
